<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPIO Light Control</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }

        .control-btn {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }

        .control-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.4);
        }

        .control-btn.danger {
            background: linear-gradient(45deg, #f44336, #d32f2f);
            box-shadow: 0 5px 15px rgba(244, 67, 54, 0.3);
        }

        .control-btn.danger:hover {
            box-shadow: 0 8px 25px rgba(244, 67, 54, 0.4);
        }

        .lights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .light-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 2px solid #f0f0f0;
        }

        .light-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }

        .light-card.on {
            border-color: #4CAF50;
            background: linear-gradient(135deg, #f8fff8 0%, #e8f5e8 100%);
        }

        .light-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .light-name {
            font-size: 1.4em;
            font-weight: bold;
            color: #333;
        }

        .light-status {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-indicator {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background: #ddd;
            transition: all 0.3s ease;
        }

        .status-indicator.on {
            background: #4CAF50;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }

        .status-text {
            font-weight: bold;
            color: #666;
        }

        .status-text.on {
            color: #4CAF50;
        }

        .light-controls {
            display: flex;
            gap: 10px;
        }

        .toggle-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .brightness-control {
            margin-top: 15px;
        }

        .brightness-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 0.9em;
            color: #555;
        }

        .brightness-value {
            font-weight: bold;
            color: #333;
        }

        .brightness-slider {
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: #ddd;
            outline: none;
            opacity: 0.7;
            transition: opacity 0.2s;
            cursor: pointer;
        }

        .brightness-slider:hover {
            opacity: 1;
        }

        .brightness-slider::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
            border: 2px solid #fff;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .brightness-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
            border: 2px solid #fff;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        .fade-controls {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .fade-btn {
            flex: 1;
            padding: 6px 10px;
            border: none;
            border-radius: 6px;
            font-size: 0.85em;
            cursor: pointer;
            transition: all 0.2s ease;
            background: #f0f0f0;
            color: #333;
        }

        .fade-btn:hover {
            background: #e0e0e0;
            transform: scale(1.02);
        }

        .pwm-info {
            margin-top: 8px;
            font-size: 0.8em;
            color: #888;
            text-align: center;
        }

        .toggle-btn.off {
            background: #4CAF50;
            color: white;
        }

        .toggle-btn.on {
            background: #f44336;
            color: white;
        }

        .toggle-btn:hover {
            transform: scale(1.05);
        }

        .pin-info {
            font-size: 0.9em;
            color: #888;
            margin-bottom: 10px;
        }

        .status-section {
            margin-top: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .status-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .status-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .status-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
        }

        .status-label {
            font-weight: bold;
            color: #555;
        }

        .status-value {
            color: #777;
        }

        .message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            z-index: 1000;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }

        .message.success {
            background: #4CAF50;
        }

        .message.error {
            background: #f44336;
        }

        .message.show {
            opacity: 1;
            transform: translateX(0);
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                padding: 20px;
            }

            .header h1 {
                font-size: 2em;
            }

            .lights-grid {
                grid-template-columns: 1fr;
            }

            .controls {
                flex-direction: column;
                align-items: center;
            }

            .control-btn {
                width: 100%;
                max-width: 300px;
            }
        }

        .refresh-btn {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.3);
        }

        .refresh-btn:hover {
            box-shadow: 0 8px 25px rgba(33, 150, 243, 0.4);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè† GPIO Light Control</h1>
            <p>Control your lights remotely via GPIO pins</p>
        </div>

        <div class="controls">
            <button class="control-btn" onclick="turnAllLightsOn()">
                üí° All Lights ON
            </button>
            <button class="control-btn danger" onclick="turnAllLightsOff()">
                üåô All Lights OFF
            </button>
            <button class="control-btn refresh-btn" onclick="refreshStatus()">
                üîÑ Refresh Status
            </button>
        </div>

        <div class="lights-grid" id="lightsGrid">
            <!-- Lights will be populated here by JavaScript -->
        </div>

        <div class="status-section">
            <div class="status-title">System Status</div>
            <div class="status-info" id="statusInfo">
                <!-- Status info will be populated here -->
            </div>
        </div>
    </div>

    <div id="message" class="message"></div>

    <script>
        // Global variables
        let lights = [];
        let systemStatus = {};

        // API endpoints
        const API_BASE = '/api';
        const ENDPOINTS = {
            lights: `${API_BASE}/lights`,
            allOn: `${API_BASE}/lights/all/on`,
            allOff: `${API_BASE}/lights/all/off`,
            status: `${API_BASE}/status`,
            toggle: (id) => `${API_BASE}/lights/${id}/toggle`,
            set: (id) => `${API_BASE}/lights/${id}/set`,
            brightness: (id) => `${API_BASE}/lights/${id}/brightness`,
            fade: (id) => `${API_BASE}/lights/${id}/fade`
        };

        // Utility functions
        function showMessage(text, type = 'success') {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message ${type}`;
            messageEl.classList.add('show');
            
            setTimeout(() => {
                messageEl.classList.remove('show');
            }, 3000);
        }

        function setLoading(element, isLoading) {
            if (isLoading) {
                element.classList.add('loading');
            } else {
                element.classList.remove('loading');
            }
        }

        // API functions
        async function apiCall(url, options = {}) {
            try {
                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error || `HTTP ${response.status}`);
                }
                
                return data;
            } catch (error) {
                console.error('API call failed:', error);
                showMessage(`Error: ${error.message}`, 'error');
                throw error;
            }
        }

        async function loadLights() {
            try {
                const response = await apiCall(ENDPOINTS.lights);
                lights = response.lights || [];
                renderLights();
            } catch (error) {
                console.error('Failed to load lights:', error);
            }
        }

        async function loadSystemStatus() {
            try {
                const response = await apiCall(ENDPOINTS.status);
                systemStatus = response;
                renderSystemStatus();
            } catch (error) {
                console.error('Failed to load system status:', error);
            }
        }

        async function toggleLight(lightId) {
            const lightCard = document.querySelector(`[data-light-id="${lightId}"]`);
            if (!lightCard) return;
            
            setLoading(lightCard, true);
            
            try {
                const response = await apiCall(ENDPOINTS.toggle(lightId), {
                    method: 'POST'
                });
                
                // Update local light state
                const light = lights.find(l => l.id === lightId);
                if (light) {
                    light.state = response.light.state;
                    renderLights();
                }
                
                showMessage(response.message);
            } catch (error) {
                console.error('Failed to toggle light:', error);
            } finally {
                setLoading(lightCard, false);
            }
        }

        async function setLight(lightId, state) {
            const lightCard = document.querySelector(`[data-light-id="${lightId}"]`);
            if (!lightCard) return;
            
            setLoading(lightCard, true);
            
            try {
                const response = await apiCall(ENDPOINTS.set(lightId), {
                    method: 'POST',
                    body: JSON.stringify({ state })
                });
                
                // Update local light state
                const light = lights.find(l => l.id === lightId);
                if (light) {
                    light.state = response.light.state;
                    renderLights();
                }
                
                showMessage(response.message);
            } catch (error) {
                console.error('Failed to set light:', error);
            } finally {
                setLoading(lightCard, false);
            }
        }

        async function turnAllLightsOn() {
            const container = document.querySelector('.container');
            setLoading(container, true);
            
            try {
                const response = await apiCall(ENDPOINTS.allOn, {
                    method: 'POST'
                });
                
                lights = response.lights || lights;
                renderLights();
                showMessage(response.message);
            } catch (error) {
                console.error('Failed to turn all lights on:', error);
            } finally {
                setLoading(container, false);
            }
        }

        async function turnAllLightsOff() {
            const container = document.querySelector('.container');
            setLoading(container, true);
            
            try {
                const response = await apiCall(ENDPOINTS.allOff, {
                    method: 'POST'
                });
                
                lights = response.lights || lights;
                renderLights();
                showMessage(response.message);
            } catch (error) {
                console.error('Failed to turn all lights off:', error);
            } finally {
                setLoading(container, false);
            }
        }

        async function refreshStatus() {
            const container = document.querySelector('.container');
            setLoading(container, true);
            
            try {
                await Promise.all([loadLights(), loadSystemStatus()]);
                showMessage('Status refreshed successfully');
            } catch (error) {
                console.error('Failed to refresh status:', error);
            } finally {
                setLoading(container, false);
            }
        }

        async function setBrightness(lightId, brightness) {
            const lightCard = document.querySelector(`[data-light-id="${lightId}"]`);
            if (!lightCard) return;
            
            try {
                const response = await apiCall(ENDPOINTS.brightness(lightId), {
                    method: 'POST',
                    body: JSON.stringify({ brightness: parseFloat(brightness) })
                });
                
                // Update local light state
                const light = lights.find(l => l.id === lightId);
                if (light) {
                    light.brightness = response.light.brightness;
                    light.state = response.light.state;
                    // Update slider display
                    const slider = lightCard.querySelector('.brightness-slider');
                    const valueDisplay = lightCard.querySelector('.brightness-value');
                    if (slider && valueDisplay) {
                        slider.value = light.brightness;
                        valueDisplay.textContent = `${Math.round(light.brightness)}%`;
                    }
                    // Update card state
                    lightCard.classList.toggle('on', light.state);
                    const indicator = lightCard.querySelector('.status-indicator');
                    const statusText = lightCard.querySelector('.status-text');
                    if (indicator && statusText) {
                        indicator.classList.toggle('on', light.state);
                        statusText.classList.toggle('on', light.state);
                        statusText.textContent = light.state ? 'ON' : 'OFF';
                    }
                }
                
                showMessage(response.message);
            } catch (error) {
                console.error('Failed to set brightness:', error);
            }
        }

        async function fadeLight(lightId, targetBrightness, fadeTime = 1.0) {
            const lightCard = document.querySelector(`[data-light-id="${lightId}"]`);
            if (!lightCard) return;
            
            setLoading(lightCard, true);
            
            try {
                const response = await apiCall(ENDPOINTS.fade(lightId), {
                    method: 'POST',
                    body: JSON.stringify({ 
                        brightness: parseFloat(targetBrightness),
                        fade_time: parseFloat(fadeTime)
                    })
                });
                
                showMessage(`Fading ${response.light ? lights.find(l => l.id === lightId)?.name : 'light'} to ${targetBrightness}%`);
                
                // Refresh after fade completes
                setTimeout(async () => {
                    await loadLights();
                    renderLights();
                }, fadeTime * 1000 + 100);
                
            } catch (error) {
                console.error('Failed to fade light:', error);
            } finally {
                setLoading(lightCard, false);
            }
        }

        // Rendering functions
        function renderLights() {
            const grid = document.getElementById('lightsGrid');
            
            if (!lights || lights.length === 0) {
                grid.innerHTML = '<div style="text-align: center; color: #666; grid-column: 1/-1;">No lights configured</div>';
                return;
            }
            
            grid.innerHTML = lights.map(light => {
                const isPwm = light.type === 'pwm';
                const brightness = light.brightness || 0;
                
                return `
                <div class="light-card ${light.state ? 'on' : ''}" data-light-id="${light.id}">
                    <div class="light-header">
                        <div class="light-name">${light.name}</div>
                        <div class="light-status">
                            <div class="status-indicator ${light.state ? 'on' : ''}"></div>
                            <span class="status-text ${light.state ? 'on' : ''}">${light.state ? 'ON' : 'OFF'}</span>
                        </div>
                    </div>
                    <div class="pin-info">GPIO Pin: ${light.pin}${isPwm ? ' (PWM)' : ''}</div>
                    <div class="light-controls">
                        <button class="toggle-btn ${light.state ? 'on' : 'off'}" 
                                onclick="toggleLight(${light.id})">
                            ${light.state ? 'üåô Turn OFF' : 'üí° Turn ON'}
                        </button>
                    </div>
                    ${isPwm ? `
                        <div class="brightness-control">
                            <div class="brightness-label">
                                <span>üîÜ Brightness</span>
                                <span class="brightness-value">${Math.round(brightness)}%</span>
                            </div>
                            <input type="range" class="brightness-slider" 
                                   min="0" max="100" value="${brightness}"
                                   oninput="setBrightness(${light.id}, this.value)"
                                   onchange="setBrightness(${light.id}, this.value)">
                            <div class="fade-controls">
                                <button class="fade-btn" onclick="fadeLight(${light.id}, 25, 1)">üåÖ 25%</button>
                                <button class="fade-btn" onclick="fadeLight(${light.id}, 50, 1)">‚òÄÔ∏è 50%</button>
                                <button class="fade-btn" onclick="fadeLight(${light.id}, 75, 1)">üî• 75%</button>
                                <button class="fade-btn" onclick="fadeLight(${light.id}, 100, 1)">‚ö° 100%</button>
                            </div>
                            <div class="pwm-info">PWM Frequency: 1kHz | Smooth dimming</div>
                        </div>
                    ` : ''}
                </div>
                `;
            }).join('');
        }

        function renderSystemStatus() {
            const statusEl = document.getElementById('statusInfo');
            
            if (!systemStatus || !systemStatus.success) {
                statusEl.innerHTML = '<div style="color: #f44336;">System status unavailable</div>';
                return;
            }
            
            const onLights = lights.filter(l => l.state).length;
            const totalLights = lights.length;
            
            statusEl.innerHTML = `
                <div class="status-item">
                    <span class="status-label">Status:</span>
                    <span class="status-value">${systemStatus.status || 'Unknown'}</span>
                </div>
                <div class="status-item">
                    <span class="status-label">GPIO Mode:</span>
                    <span class="status-value">${systemStatus.gpio_mode || 'Unknown'}</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Lights ON:</span>
                    <span class="status-value">${onLights} / ${totalLights}</span>
                </div>
                <div class="status-item">
                    <span class="status-label">Last Update:</span>
                    <span class="status-value">${new Date().toLocaleTimeString()}</span>
                </div>
            `;
        }

        // Initialize the application
        async function init() {
            try {
                await Promise.all([loadLights(), loadSystemStatus()]);
                console.log('GPIO Light Control initialized');
            } catch (error) {
                console.error('Failed to initialize:', error);
                showMessage('Failed to initialize application', 'error');
            }
        }

        // Auto-refresh every 30 seconds
        setInterval(async () => {
            try {
                await loadLights();
            } catch (error) {
                console.error('Auto-refresh failed:', error);
            }
        }, 30000);

        // Start the application when page loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>